// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// TABELAS CORE DO SISTEMA
// ============================================

model Empresa {
  id               Int         @id @default(autoincrement())
  cnpj             String      @unique @db.VarChar(14)
  razaoSocial      String      @map("razao_social")
  nomeFantasia     String?     @map("nome_fantasia")
  telefone         String?
  email            String?
  // Endereço
  endereco         String
  numero           String?
  complemento      String?
  bairro           String
  cidade           String
  uf               String      @db.VarChar(2)
  cep              String      @db.VarChar(8)
  // Configurações
  ativo            Boolean     @default(true)
  logo             String?     @db.LongText
  horarioAbertura  String?     @map("horario_abertura")
  horarioFechamento String?    @map("horario_fechamento")
  taxaEntrega      Decimal     @default(0) @db.Decimal(10, 2) @map("taxa_entrega")
  tempoMedioEntrega Int?       @map("tempo_medio_entrega") // em minutos
  pedidoMinimo     Decimal?    @default(0) @db.Decimal(10, 2) @map("pedido_minimo")
  descricao        String?     @db.Text
  chavePix         String?     @map("chave_pix")
  whatsapp         String?
  instagram        String?
  facebook         String?
  // Timestamps
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relacionamentos
  usuarios         Usuario[]
  categorias       Categoria[]
  produtos         Produto[]
  pedidos          Pedido[]
  gruposAdicionais GrupoAdicional[]

  @@map("empresa")
}

model Usuario {
  id             Int          @id @default(autoincrement())
  empresaId      Int          @map("empresa_id")
  nome           String
  email          String       @unique
  senha          String
  telefone       String?
  cpf            String?      @unique @db.VarChar(11)
  foto           String?      @db.LongText
  permissaoId    Int          @map("permissao_id")
  ativo          Boolean      @default(true)
  resetToken     String?      @map("reset_token")
  resetTokenExpiry DateTime?  @map("reset_token_expiry")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relacionamentos
  empresa        Empresa      @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  permissao      Permissao    @relation(fields: [permissaoId], references: [id])
  enderecos      Endereco[]
  pedidos        Pedido[]

  @@map("usuario")
}

model Permissao {
  id        Int       @id @default(autoincrement())
  nome      String    @unique // admin, cliente, entregador
  descricao String?

  usuarios  Usuario[]

  @@map("permissao")
}

// ============================================
// TABELAS DE DELIVERY
// ============================================

model Categoria {
  id          Int       @id @default(autoincrement())
  empresaId   Int       @map("empresa_id")
  nome        String
  descricao   String?   @db.Text
  ordem       Int       @default(0)
  ativo       Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  empresa     Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  produtos    Produto[]

  @@map("categoria")
}

model Produto {
  id          Int         @id @default(autoincrement())
  empresaId   Int         @map("empresa_id")
  categoriaId Int         @map("categoria_id")
  nome        String
  descricao   String?     @db.Text
  preco       Decimal     @db.Decimal(10, 2)
  imagem      String?     @db.LongText
  disponivel  Boolean     @default(true)
  destaque    Boolean     @default(false)
  vendidoPorKg Boolean    @default(false) @map("vendido_por_kg")
  tempoPreparo Int?       @map("tempo_preparo") // Tempo de preparo em minutos
  ordem       Int         @default(0)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  empresa     Empresa     @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  categoria   Categoria   @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  itensPedido ItemPedido[]
  gruposProduto ProdutoGrupoAdicional[]

  @@map("produto")
}

// ============================================
// SISTEMA DE ADICIONAIS
// ============================================

// Grupo de Adicionais (ex: "Pontos da Carne", "Adicionais", "Bebidas")
model GrupoAdicional {
  id          Int       @id @default(autoincrement())
  empresaId   Int       @map("empresa_id")
  nome        String    // Ex: "Pontos da Carne", "Molhos", "Bebidas"
  descricao   String?   @db.Text
  minimo      Int       @default(0) // Quantidade mínima de adicionais
  maximo      Int       @default(1) // Quantidade máxima de adicionais
  obrigatorio Boolean   @default(false)
  tipoPrecificacao String @default("somatorio") @map("tipo_precificacao") // somatorio, substitui
  tipoSelecao String    @default("RADIO") @map("tipo_selecao") // RADIO ou CHECKBOX
  minimoSelecao Int     @default(0) @map("minimo_selecao") // Para CHECKBOX
  maximoSelecao Int     @default(1) @map("maximo_selecao") // Para CHECKBOX
  ordem       Int       @default(0)
  ativo       Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  empresa     Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  adicionais  Adicional[]
  produtos    ProdutoGrupoAdicional[]

  @@map("grupo_adicional")
}

// Adicionais dentro de cada grupo (ex: "Mal Passada", "Ao Ponto", "Bem Passada")
model Adicional {
  id              Int       @id @default(autoincrement())
  grupoAdicionalId Int      @map("grupo_adicional_id")
  nome            String    // Ex: "Mal Passada", "Bacon", "Queijo Extra"
  descricao       String?   @db.Text
  preco           Decimal   @default(0) @db.Decimal(10, 2)
  ordem           Int       @default(0)
  ativo           Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  grupoAdicional  GrupoAdicional @relation(fields: [grupoAdicionalId], references: [id], onDelete: Cascade)
  itensAdicional  ItemAdicional[]

  @@map("adicional")
}

// Relacionamento entre Produto e Grupo de Adicionais (um produto pode ter vários grupos)
model ProdutoGrupoAdicional {
  id              Int       @id @default(autoincrement())
  produtoId       Int       @map("produto_id")
  grupoAdicionalId Int      @map("grupo_adicional_id")
  ordem           Int       @default(0) // Ordem de exibição no produto
  createdAt       DateTime  @default(now()) @map("created_at")

  produto         Produto   @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  grupoAdicional  GrupoAdicional @relation(fields: [grupoAdicionalId], references: [id], onDelete: Cascade)

  @@unique([produtoId, grupoAdicionalId])
  @@map("produto_grupo_adicional")
}

// ============================================
// TABELAS DE PEDIDOS
// ============================================

model Endereco {
  id          Int       @id @default(autoincrement())
  usuarioId   Int       @map("usuario_id")
  titulo      String    // "Casa", "Trabalho", etc.
  cep         String    @db.VarChar(8)
  logradouro  String
  numero      String
  complemento String?
  bairro      String
  cidade      String
  uf          String    @db.VarChar(2)
  referencia  String?   @db.Text
  principal   Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  usuario     Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  pedidos     Pedido[]

  @@map("endereco")
}

model StatusPedido {
  id          Int      @id @default(autoincrement())
  codigo      String   @unique @db.VarChar(50) // pendente, confirmado, em_preparo, pronto, em_entrega, entregue, cancelado
  nome        String   @db.VarChar(100) // Nome amigável: "Em Análise", "Confirmado", etc
  descricao   String?  @db.Text
  cor         String?  @db.VarChar(20) // Hex color para UI
  ordem       Int      @default(0) // Ordem de exibição
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  pedidos     Pedido[]
  historicos  HistoricoPedido[]

  @@map("status_pedido")
}

model Pedido {
  id                Int            @id @default(autoincrement())
  empresaId         Int            @map("empresa_id")
  usuarioId         Int            @map("usuario_id")
  enderecoId        Int            @map("endereco_id")
  statusId          Int            @map("status_id")
  numero            String         @unique
  subtotal          Decimal        @db.Decimal(10, 2)
  taxaEntrega       Decimal        @db.Decimal(10, 2) @map("taxa_entrega")
  total             Decimal        @db.Decimal(10, 2)
  formaPagamento    String         @map("forma_pagamento") // dinheiro, cartao, pix
  observacoes       String?        @db.Text
  motivoCancelamento String?       @db.Text @map("motivo_cancelamento")
  tempoEstimado     Int?           @map("tempo_estimado") // em minutos
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  empresa           Empresa        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  usuario           Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  endereco          Endereco       @relation(fields: [enderecoId], references: [id])
  status            StatusPedido   @relation(fields: [statusId], references: [id])
  itens             ItemPedido[]
  historico         HistoricoPedido[]

  @@map("pedido")
}

model ItemPedido {
  id          Int       @id @default(autoincrement())
  pedidoId    Int       @map("pedido_id")
  produtoId   Int       @map("produto_id")
  quantidade  Int       @default(1)
  precoUnitario Decimal @db.Decimal(10, 2) @map("preco_unitario")
  subtotal    Decimal   @db.Decimal(10, 2)
  observacoes String?   @db.Text

  pedido      Pedido    @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  produto     Produto   @relation(fields: [produtoId], references: [id])
  adicionais  ItemAdicional[]

  @@map("item_pedido")
}

// Adicionais escolhidos em cada item do pedido
model ItemAdicional {
  id            Int       @id @default(autoincrement())
  itemPedidoId  Int       @map("item_pedido_id")
  adicionalId   Int       @map("adicional_id")
  quantidade    Int       @default(1)
  preco         Decimal   @db.Decimal(10, 2) // Preço no momento do pedido

  itemPedido    ItemPedido @relation(fields: [itemPedidoId], references: [id], onDelete: Cascade)
  adicional     Adicional  @relation(fields: [adicionalId], references: [id])

  @@map("item_adicional")
}

model HistoricoPedido {
  id          Int          @id @default(autoincrement())
  pedidoId    Int          @map("pedido_id")
  statusId    Int          @map("status_id")
  observacao  String?      @db.Text
  createdAt   DateTime     @default(now()) @map("created_at")

  pedido      Pedido       @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  status      StatusPedido @relation(fields: [statusId], references: [id])

  @@map("historico_pedido")
}
